<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Visualization</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        #cy {
            width: 100%;
            height: 700px;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #info {
            margin-top: 10px;
            padding: 8px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: pre-line;
        }
    </style>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
    <h1>System Visualization</h1>
    <div id="cy"></div>
    <div id="info"></div>
    <script>
        async function loadGraph() {
            const response = await fetch('edges.csv');
            const csvText = await response.text();
            const parsed = Papa.parse(csvText.trim(), { header: true });

            const nodes = new Map();
            const edges = [];

            const classifyTrend = trend => {
                const t = trend.toLowerCase();
                if (t.includes('ökar') || t.includes('ökande') || t.includes('positiv')) return 'positive';
                if (t.includes('minskar') || t.includes('negativ')) return 'negative';
                return 'neutral';
            };

            parsed.data.forEach(row => {
                const code = (row['Kod'] || '').trim();
                const type = (row['type'] || '').trim().toLowerCase();
                if (!code || !type) return;

                if (type === 'node') {
                    const label = (row['Komponent (box)'] || code).trim();
                    const description = (row['Beskrivning'] || '').trim();
                    nodes.set(code, { data: { id: code, label, description } });
                } else if (type === 'edge') {
                    const src = (row['from_node_corrected'] || row['from_node'] || '').trim();
                    const tgt = (row['to_node_corrected'] || row['to_node'] || '').trim();
                    if (!src || !tgt) return;

                    const trend = (row['Trend'] || '').trim();
                    const confidence = (row['Tillförlitlighet av kunskapen'] || '').trim();
                    const reference = (row['Exempel på källor'] || '').trim();

                    edges.push({
                        data: {
                            id: code,
                            source: src,
                            target: tgt,
                            trend,
                            effect: classifyTrend(trend),
                            confidence,
                            confidenceClass: confidence.toLowerCase().includes('osäker') ? 'unsure' : 'sure',
                            reference
                        }
                    });
                }
            });

            edges.forEach(e => {
                if (!nodes.has(e.data.source)) {
                    nodes.set(e.data.source, { data: { id: e.data.source, label: e.data.source, description: '' } });
                }
                if (!nodes.has(e.data.target)) {
                    nodes.set(e.data.target, { data: { id: e.data.target, label: e.data.target, description: '' } });
                }
            });

            const elements = Array.from(nodes.values()).concat(edges);

            const cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                layout: { name: 'cose' },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'content': 'data(label)',
                            'text-valign': 'center',
                            'color': '#fff',
                            'background-color': '#3498db',
                            'text-outline-color': '#3498db',
                            'text-outline-width': 2
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'triangle',
                            'width': 2,
                            'line-color': '#999',
                            'target-arrow-color': '#999'
                        }
                    },
                    {
                        selector: "edge[effect = 'positive']",
                        style: {
                            'line-color': '#27ae60',
                            'target-arrow-color': '#27ae60',
                            'width': 3
                        }
                    },
                    {
                        selector: "edge[effect = 'negative']",
                        style: {
                            'line-color': '#c0392b',
                            'target-arrow-color': '#c0392b',
                            'width': 3
                        }
                    },
                    {
                        selector: "edge[confidenceClass = 'unsure']",
                        style: {
                            'line-style': 'dashed'
                        }
                    }
                ]
            });

            cy.on('tap', 'edge', evt => {
                const d = evt.target.data();
                const info = `Trend: ${d.trend}\nConfidence: ${d.confidence}\nSources: ${d.reference}`;
                document.getElementById('info').textContent = info;
            });

            cy.on('tap', 'node', evt => {
                const n = evt.target;
                const d = n.data();
                const info = `Node: ${d.label}\nIncoming edges: ${n.incomers('edge').length}\nOutgoing edges: ${n.outgoers('edge').length}\n${d.description || ''}`;
                document.getElementById('info').textContent = info;
            });
        }

        loadGraph();
    </script>
</body>
</html>
